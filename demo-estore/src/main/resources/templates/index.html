<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>Insert title here</title>
<link rel="stylesheet" href="/main.css" />
<script src="webjars/requirejs/2.2.0/require.js"></script>
</head>
<body>

	<h3 th:if="${#vars['flash.message']}" th:text="${#vars['flash.message']}" class="flash"></h3>

	<h2>Demo Spring boot application</h2>
	<div>
		<form action="/images" method="post" enctype="multipart/form-data">
			<p>
				<input type="file" name="file" />
			</p>
			<input type="submit" name="Upload" />
		</form>
	</div>

	<div>
		<h3 th:text="${page.number + 1} + ' of ' + ${page.totalPages}"></h3>

		<ul>
			<li th:if="${prev}"><a th:href="@{/(size=${prev.pageSize}, page=${prev.pageNumber})}">Previous</a></li>
			<li th:if="${next}"><a th:href="@{/(size=${next.pageSize}, page=${next.pageNumber})}">Next</a></li>
		</ul>

		<table>
			<thead>
				<tr>
					<th>ID</th>
					<th>Name</th>
					<th>Image</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="image : ${page.content}">
					<td th:text="${image.id}" />
					<td th:text="${image.name}" />
					<td><a th:href="@{'/images/' + ${image.name} + '/raw'}"> <img th:src="@{'/images/' + ${image.name} + '/raw'}" class="thumbnail" />
					</a></td>
					<td>
						<form th:method="delete" th:action="@{'/images/' + ${image.name}}">
							<input type="submit" value="Delete" />
						</form>
					</td>
				</tr>
			</tbody>

		</table>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		(function() {
			window.require([ 'webjars/stompjs/2.3.3/lib/stomp', 'webjars/sockjs-client/1.1.1/sockjs' ], function(
					stomp, SockJS) {
				
				var redrawCurrentPage = function(message) {
					console.log(message);
					window.location =/*[[@{/(size=${page.size}, page=${page.number})}]]*/;
				}
				
				var socket = SockJS('/imageMessages');
				var stompClient = Stomp.over(socket);
				stompClient.connect({/* optional headers */}, function(frame) {
					stompClient.subscribe("/topic/newImage", redrawCurrentPage);
					stompClient.subscribe("/topic/deleteImage", redrawCurrentPage);
				});

			});
		})();
		/*]]>*/
	</script>

</body>
</html>